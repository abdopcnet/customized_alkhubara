const root = root_element;\r\n\r\nroot.innerHTML = `\r\n<style>\r\n  /* Modern Reset & Base */\r\n  .mp-wrap {\r\n    font-family: 'Inter', system-ui, -apple-system, sans-serif;\r\n    padding: 24px;\r\n    background: #f8fafc; /* Slate 50 */\r\n    min-height: calc(100vh - 180px);\r\n    color: #334155; /* Slate 700 */\r\n  }\r\n\r\n  .mp-card {\r\n    background: #ffffff;\r\n    border-radius: 16px;\r\n    padding: 24px;\r\n    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);\r\n    border: 1px solid #e2e8f0; /* Slate 200 */\r\n  }\r\n\r\n  /* Header Section */\r\n  .mp-top {\r\n    display: flex;\r\n    gap: 20px;\r\n    flex-wrap: wrap;\r\n    align-items: flex-end;\r\n    margin-bottom: 24px;\r\n    border-bottom: 1px solid #f1f5f9;\r\n    padding-bottom: 24px;\r\n  }\r\n\r\n  .mp-label {\r\n    font-size: 0.875rem;\r\n    font-weight: 600;\r\n    color: #64748b; /* Slate 500 */\r\n    margin-bottom: 8px;\r\n    display: block;\r\n  }\r\n\r\n  /* Buttons */\r\n  .mp-btns {\r\n    display: flex;\r\n    gap: 12px;\r\n    flex-wrap: wrap;\r\n    margin-right: auto; /* Push to left in RTL */\r\n  }\r\n\r\n  .mp-btns .btn {\r\n    border-radius: 8px;\r\n    padding: 10px 16px;\r\n    font-weight: 600;\r\n    font-size: 0.875rem;\r\n    transition: all 0.2s;\r\n    border: none;\r\n    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);\r\n  }\r\n\r\n  .btn-primary { background-color: #3b82f6; color: white; }\r\n  .btn-primary:hover { background-color: #2563eb; }\r\n  .btn-success { background-color: #10b981; color: white; }\r\n  .btn-success:hover { background-color: #059669; }\r\n  .btn-default { background-color: #ffffff; color: #334155; border: 1px solid #cbd5e1 !important; }\r\n  .btn-default:hover { background-color: #f8fafc; }\r\n\r\n  /* KPI Cards */\r\n  .mp-kpis {\r\n    display: grid;\r\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\r\n    gap: 16px;\r\n    margin-bottom: 24px;\r\n  }\r\n\r\n  .mp-kpi {\r\n    background: #ffffff;\r\n    border-radius: 12px;\r\n    padding: 20px;\r\n    border: 1px solid #e2e8f0;\r\n    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);\r\n    display: flex;\r\n    flex-direction: column;\r\n    justify-content: center;\r\n  }\r\n\r\n  .mp-kpi .v {\r\n    font-size: 2rem;\r\n    font-weight: 700;\r\n    color: #0f172a; /* Slate 900 */\r\n    line-height: 1;\r\n    margin-bottom: 4px;\r\n  }\r\n\r\n  .mp-kpi .t {\r\n    font-size: 0.875rem;\r\n    color: #64748b;\r\n    font-weight: 500;\r\n  }\r\n\r\n  /* Search Bar */\r\n  .mp-search {\r\n    position: relative;\r\n    margin-bottom: 24px;\r\n  }\r\n\r\n  .mp-search input.form-control {\r\n    width: 100%;\r\n    max-width: 100%;\r\n    border-radius: 12px;\r\n    padding: 12px 16px;\r\n    border: 1px solid #cbd5e1;\r\n    font-size: 0.95rem;\r\n    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);\r\n    transition: all 0.2s;\r\n  }\r\n\r\n  .mp-search input.form-control:focus {\r\n    border-color: #3b82f6;\r\n    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);\r\n    outline: none;\r\n  }\r\n\r\n  .mp-stat {\r\n    position: absolute;\r\n    left: 16px;\r\n    top: 50%;\r\n    transform: translateY(-50%);\r\n    font-size: 0.8rem;\r\n    color: #94a3b8;\r\n  }\r\n\r\n  /* Grid List Replaced with Table */\r\n  .mp-table-wrap {\r\n    overflow-x: auto;\r\n    background: #ffffff;\r\n    border-radius: 12px;\r\n    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);\r\n    border: 1px solid #e2e8f0;\r\n  }\r\n\r\n  .mp-table {\r\n    width: 100%;\r\n    border-collapse: collapse;\r\n    font-size: 0.9rem;\r\n  }\r\n\r\n  .mp-table th {\r\n    background: #f8fafc;\r\n    padding: 16px;\r\n    text-align: right;\r\n    font-weight: 600;\r\n    color: #475569;\r\n    border-bottom: 1px solid #e2e8f0;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  .mp-table td {\r\n    padding: 16px;\r\n    border-bottom: 1px solid #f1f5f9;\r\n    color: #334155;\r\n    vertical-align: middle;\r\n  }\r\n\r\n  .mp-table tr:last-child td {\r\n    border-bottom: none;\r\n  }\r\n\r\n  .mp-table tr:hover td {\r\n    background: #f8fafc;\r\n  }\r\n\r\n  /* Status Cell */\r\n  .status-cell {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 8px;\r\n  }\r\n\r\n  .mp-notes-cell {\r\n    max-width: 250px;\r\n    white-space: nowrap;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n    color: #94a3b8;\r\n  }\r\n\r\n  /* Badges */\r\n  .badge {\r\n    padding: 4px 8px;\r\n    font-size: 0.75rem;\r\n    font-weight: 600;\r\n    border-radius: 6px;\r\n    display: inline-flex;\r\n    align-items: center;\r\n    gap: 4px;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  .b-over { background: #fef2f2; color: #ef4444; }\r\n  .b-due { background: #fffbeb; color: #b45309; }\r\n  .b-ok { background: #f0fdf4; color: #15803d; }\r\n  .b-info { background: #eff6ff; color: #1d4ed8; }\r\n\r\n  @media (max-width: 768px){\r\n    .mp-top { flex-direction: column; align-items: stretch; gap: 16px; }\r\n    .mp-btns { width: 100%; justify-content: stretch; }\r\n    .mp-btns .btn { flex: 1; text-align: center; }\r\n    .mp-kpis { grid-template-columns: repeat(2, 1fr); }\r\n  }\r\n</style>\r\n\r\n<div class=\"mp-wrap\">\r\n  <div class=\"mp-card\">\r\n    <div class=\"mp-top\">\r\n      <div style=\"flex: 1; min-width: 250px;\">\r\n        <label class=\"mp-label\">العميل</label>\r\n        <div id=\"mp_customer\"></div>\r\n      </div>\r\n\r\n      <div class=\"mp-btns\">\r\n        <button class=\"btn btn-primary\" id=\"mp_refresh\">\r\n          <i class=\"fa fa-refresh\"></i> تحديث\r\n        </button>\r\n        <button class=\"btn btn-success\" id=\"mp_run_all\">\r\n          <i class=\"fa fa-play\"></i> تشغيل المستحق\r\n        </button>\r\n        <button class=\"btn btn-default\" id=\"mp_add\">\r\n          <i class=\"fa fa-plus\"></i> إضافة جدول\r\n        </button>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"mp-kpis\">\r\n      <div class=\"mp-kpi\">\r\n        <div class=\"v\" id=\"k_total\">0</div>\r\n        <div class=\"t\">إجمالي الجداول</div>\r\n      </div>\r\n      <div class=\"mp-kpi\" style=\"border-left: 4px solid #ef4444;\">\r\n        <div class=\"v\" id=\"k_over\" style=\"color: #ef4444;\">0</div>\r\n        <div class=\"t\">متأخر (سالب)</div>\r\n      </div>\r\n      <div class=\"mp-kpi\" style=\"border-left: 4px solid #f59e0b;\">\r\n        <div class=\"v\" id=\"k_due7\" style=\"color: #f59e0b;\">0</div>\r\n        <div class=\"t\">خلال 7 أيام</div>\r\n      </div>\r\n      <div class=\"mp-kpi\">\r\n        <div class=\"v\" id=\"k_next\">-</div>\r\n        <div class=\"t\">أقرب تشغيل</div>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"mp-search\">\r\n      <input id=\"mp_search\" class=\"form-control\" placeholder=\"بحث في الجدول… (اسم العميل / المشروع / ملاحظات)\">\r\n      <div id=\"mp_stat\" class=\"mp-stat\"></div>\r\n    </div>\r\n  </div>\r\n\r\n  <br>\r\n\r\n  <div class=\"mp-table-wrap\">\r\n    <table class=\"mp-table\">\r\n      <thead>\r\n        <tr>\r\n          <th>المشروع</th>\r\n          <th>العميل</th>\r\n          <th>التكرار</th>\r\n          <th>التشغيل القادم</th>\r\n          <th>آخر تشغيل</th>\r\n          <th>ملاحظات</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody id=\"mp_list\"></tbody>\r\n    </table>\r\n  </div>\r\n</div>\r\n`;\r\n\r\n// Customer link control\r\nconst customer_control = frappe.ui.form.make_control({\r\n  parent: root.querySelector(\"#mp_customer\"),\r\n  df: { fieldtype: \"Link\", options: \"Customer\", fieldname: \"customer\" },\r\n  render_input: true\r\n});\r\n\r\n// FIX: Prevent global search from hijacking focus\r\nconst customer_input = root.querySelector(\"#mp_customer input\");\r\nif(customer_input) {\r\n    customer_input.addEventListener(\"keydown\", (e) => {\r\n        e.stopPropagation();\r\n    });\r\n}\r\n\r\nconst listEl = root.querySelector(\"#mp_list\");\r\nconst searchInput = root.querySelector(\"#mp_search\");\r\n\r\n// FIX: Prevent global search from hijacking focus on search bar too\r\nif(searchInput) {\r\n    searchInput.addEventListener(\"keydown\", (e) => {\r\n        e.stopPropagation();\r\n    });\r\n}\r\n\r\nlet DATA = [];\r\n\r\nfunction esc(v){ return frappe.utils.escape_html((v ?? \"\").toString()); }\r\n\r\nfunction toDate(s){\r\n  if(!s) return null;\r\n  try { return frappe.datetime.str_to_obj(s); } catch(e){ return null; }\r\n}\r\n\r\nfunction daysDiff(target){\r\n  const t = toDate(target);\r\n  if(!t) return null;\r\n  const now = toDate(frappe.datetime.nowdate());\r\n  const ms = t.getTime() - now.getTime();\r\n  return Math.ceil(ms / 86400000); // عدّاد بالأيام\r\n}\r\n\r\n// عدّاد ذكي\r\nfunction badgeFor(diff){\r\n  if(diff === null) return {cls:\"b-info\", txt:\"بدون موعد\"};\r\n\r\n  if(diff < 0){\r\n    return {cls:\"b-over\", txt:`متأخر ${Math.abs(diff)} يوم`};\r\n  }\r\n\r\n  if(diff === 0){\r\n    return {cls:\"b-due\", txt:\"اليوم\"};\r\n  }\r\n\r\n  if(diff <= 7){\r\n    return {cls:\"b-due\", txt:`بعد ${diff} يوم`};\r\n  }\r\n\r\n  if(diff <= 30){\r\n    return {cls:\"b-ok\", txt:`بعد ${Math.ceil(diff/7)} أسبوع`};\r\n  }\r\n\r\n  return {cls:\"b-ok\", txt:`بعد ${Math.ceil(diff/30)} شهر`};\r\n}\r\n\r\nfunction computeKPIs(rows){\r\n  const total = rows.length;\r\n  const diffs = rows\r\n    .map(r => daysDiff(r.تاريخ_التشغيل_القادم || r.تاريخ_الانشاء))\r\n    .filter(x => x !== null);\r\n\r\n  const over = diffs.filter(d => d < 0).length;\r\n  const due7 = diffs.filter(d => d >= 0 && d <= 7).length;\r\n  const next = diffs.length ? Math.min(...diffs) : null;\r\n\r\n  root.querySelector(\"#k_total\").textContent = total;\r\n  root.querySelector(\"#k_over\").textContent = over;\r\n  root.querySelector(\"#k_due7\").textContent = due7;\r\n  root.querySelector(\"#k_next\").textContent = (next === null) ? \"-\" : (next < 0 ? `${next}` : `${next} يوم`);\r\n}\r\n\r\nfunction render(rows){\r\n  const q = (searchInput.value || \"\").toLowerCase();\r\n  let filtered = rows.filter(r => JSON.stringify(r).toLowerCase().includes(q));\r\n\r\n  // ترتيب أذكى\r\n  filtered.sort((a,b)=>{\r\n    const da = daysDiff(a.تاريخ_التشغيل_القادم || a.تاريخ_الانشاء);\r\n    const db = daysDiff(b.تاريخ_التشغيل_القادم || b.تاريخ_الانشاء);\r\n\r\n    const wa = da < 0 ? 0 : da <= 0 ? 1 : da <= 7 ? 2 : da <= 30 ? 3 : 4;\r\n    const wb = db < 0 ? 0 : db <= 0 ? 1 : db <= 7 ? 2 : db <= 30 ? 3 : 4;\r\n\r\n    if(wa !== wb) return wa - wb;\r\n    return (da ?? 999999) - (db ?? 999999);\r\n  });\r\n\r\n  computeKPIs(filtered);\r\n\r\n  listEl.innerHTML = filtered.map(r=>{\r\n    const nextRef = r.تاريخ_التشغيل_القادم || r.تاريخ_الانشاء;\r\n    const diff = daysDiff(nextRef);\r\n    const b = badgeFor(diff);\r\n\r\n    // Urgent styles not needed on rows, maybe just a border on the left or text color\r\n    const rowClass = diff !== null && diff < 0 ? 'bg-red-50' : '';\r\n\r\n    return `\r\n    <tr class=\"${rowClass}\">\r\n      <td>\r\n        <div style=\"font-weight:700; color:#0f172a;\">${esc(r.المشروع || \"-\")}</div>\r\n        <div style=\"font-size:0.8rem; color:#94a3b8;\">أنشئ: ${esc(r.تاريخ_الانشاء || \"-\")}</div>\r\n      </td>\r\n      <td>\r\n        <div style=\"font-weight:600;\">${esc(r.parent || \"-\")}</div>\r\n      </td>\r\n      <td>\r\n        <span class=\"badge b-info\">\r\n           ${esc((r.عدد_شهور_التشغيل ?? \"-\") + \" شهر\")}\r\n        </span>\r\n        <div style=\"font-size:0.8rem; color:#94a3b8; margin-top:4px\">يوم: ${esc(r.يوم_التشغيل_في_شهر_التشغيل || \"-\")}</div>\r\n      </td>\r\n      <td>\r\n        <div class=\"status-cell\">\r\n          <span class=\"badge ${b.cls}\">\r\n            ${esc(b.txt)}\r\n          </span>\r\n        </div>\r\n        <div style=\"font-size:0.8rem; color:#64748b; margin-top:4px; font-weight:600\">${esc(nextRef || \"-\")}</div>\r\n      </td>\r\n      <td>\r\n        <div style=\"font-weight:600; color:#334155;\">${esc(r.اخر_تاريخ_تشغيل || \"-\")}</div>\r\n      </td>\r\n      <td class=\"mp-notes-cell\" title=\"${esc(r.ملاحظات || \"\")}\">\r\n        ${esc(r.ملاحظات || \"—\")}\r\n      </td>\r\n    </tr>\r\n    `;\r\n  }).join(\"\");\r\n\r\n  root.querySelector(\"#mp_stat\").textContent = `${filtered.length} نتيجة`;\r\n}\r\n\r\nasync function load(){\r\n  // Removed mp_only_due checkbox logic\r\n  const only_due = 0; \r\n  // Get value from the control if possible, or input\r\n  const val = customer_control ? customer_control.get_value() : customer_input.value;\r\n  const customer = (val || \"\").trim();\r\n\r\n  try {\r\n      const r = await frappe.call({\r\n        method: \"monthly_projects_dashboard\",\r\n        args: { action: \"get\", customer, only_due }\r\n      });\r\n\r\n      DATA = r.message || [];\r\n      render(DATA);\r\n  } catch(e) {\r\n      console.error(e);\r\n      // Fallback if method fails\r\n      root.querySelector(\"#mp_stat\").textContent = \"خطأ في التحميل\";\r\n  }\r\n}\r\n\r\nroot.querySelector(\"#mp_refresh\").onclick = load;\r\nsearchInput.oninput = ()=>render(DATA);\r\n\r\nroot.querySelector(\"#mp_run_all\").onclick = ()=>{\r\n  frappe.confirm(\"هل أنت متأكد من تشغيل جميع المشاريع المستحقة الآن؟\", ()=>{\r\n    frappe.call({\r\n      method: \"monthly_projects_run_all_due\",\r\n      callback: (r)=>{\r\n        const m = r.message || {};\r\n        frappe.msgprint(`تمت العملية بنجاح: <br> تم إنشاء ${m.created_projects||0} مشروع <br> تم تحديث ${m.updated_customers||0} عميل`);\r\n        load();\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\nroot.querySelector(\"#mp_add\").onclick = ()=>{\r\n  const d = new frappe.ui.Dialog({\r\n    title: \"إضافة جدول مشروع جديد\",\r\n    fields: [\r\n      {fieldtype:\"Link\", fieldname:\"customer\", label:\"العميل\", options:\"Customer\", reqd:1},\r\n      {fieldtype:\"Link\", fieldname:\"template\", label:\"قالب المشروع\", options:\"Project Template\", reqd:1},\r\n      {fieldtype:\"Date\", fieldname:\"creation_date\", label:\"تاريخ البداية\", default: frappe.datetime.nowdate()},\r\n      {fieldtype:\"Int\", fieldname:\"freq_months\", label:\"تكرار كل (أشهر)\", default: 3, reqd:1},\r\n      {fieldtype:\"Int\", fieldname:\"day_of_month\", label:\"يوم الاستحقاق في الشهر\", default: 1, reqd:1},\r\n      {fieldtype:\"Small Text\", fieldname:\"notes\", label:\"ملاحظات\"},\r\n    ],\r\n    primary_action_label: \"حفظ البيانات\",\r\n    primary_action(values){\r\n      frappe.call({\r\n        method: \"monthly_projects_dashboard\",\r\n        args: { action:\"add\", ...values },\r\n        callback(){\r\n          frappe.msgprint({title: 'تم بنجاح', message: \"تمت إضافة الجدول الجديد بنجاح\", indicator: 'green'});\r\n          d.hide();\r\n          load();\r\n        }\r\n      });\r\n    }\r\n  });\r\n  d.show();\r\n};\r\n\r\n// أول تحميل + تحديث تلقائي كل 5 دقائق\r\nload();\r\nsetInterval(()=>load(), 5 * 60 * 1000); 